<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Duyệt Vé</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/assets/css/movie.css}">
</head>
<body>
<!-- =============== Navigation ================ -->
<div th:replace="~{Admin/navMenu:: navbar}"></div>

<div id="dashboard" class="content active">
    <div class="main">
        <div class="topbar">
            <div class="toggle">
                <ion-icon name="menu-outline"></ion-icon>
            </div>
        </div>
    <div class="container mt-4">
        <h2>Quản lý Duyệt Vé</h2>
        <div id="bookingContainer">
            <!-- Danh sách các vé cần duyệt sẽ được load vào đây -->
        </div>
    </div>
    </div>
</div>

<script th:src="@{/assets/js/adminJS/main.js}"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- ====== ionicons ======= -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<script>
    const bookingApiUrl = "http://localhost:8080/api/booking"; // API cơ bản của Booking
    const movieApiUrl = "http://localhost:8080/api/movies"; // API cơ bản của Movie

    // Hàm load danh sách vé
    function loadBookings() {
        $.get(`${bookingApiUrl}/pending`, function(data) { // API giả định trả về các vé chưa duyệt
            $('#bookingContainer').empty();
            if (data.length === 0) {
                $('#bookingContainer').html('<p>Không có vé nào cần duyệt.</p>');
                return;
            }

            let html = `<table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Phim</th>
                        <th>Phòng</th>
                        <th>Ghế</th>
                        <th>Thời gian</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>`;
            data.forEach(booking => {
                html += `
                    <tr>
                        <td>${booking.bookingId}</td>
                        <td>${booking.movieName}</td>
                        <td>${booking.roomName}</td>
                        <td>${booking.seatNumber}</td>
                        <td>${new Date(booking.startTime).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-success btn-sm approveBtn" data-id="${booking.bookingId}">Duyệt</button>
                            <button class="btn btn-danger btn-sm rejectBtn" data-id="${booking.bookingId}">Hủy</button>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table>`;
            $('#bookingContainer').html(html);
        });
    }

    // Hàm duyệt vé
    function approveBooking(id) {
        $.ajax({
            url: `${bookingApiUrl}/booking/${id}/approve`,
            type: 'PUT',
            success: function() {
                alert('Duyệt vé thành công!');
                loadBookings();
            },
            error: function() {
                alert('Có lỗi xảy ra khi duyệt vé.');
            }
        });
    }

    // Hàm hủy vé
    function rejectBooking(id) {
        $.ajax({
            url: `${bookingApiUrl}/${id}`, // API giả định để hủy vé
            type: 'DELETE',
            success: function() {
                alert('Hủy vé thành công!');
                loadBookings();
            },
            error: function() {
                alert('Có lỗi xảy ra khi hủy vé.');
            }
        });
    }

    // Gắn sự kiện khi trang sẵn sàng
    $(document).ready(function() {
        loadBookings(); // Load danh sách vé khi trang mở

        // Xử lý sự kiện duyệt vé
        $(document).on('click', '.approveBtn', function() {
            const bookingId = $(this).data('id');
            if (confirm('Bạn có chắc chắn muốn duyệt vé này?')) {
                approveBooking(bookingId);
            }
        });

        // Xử lý sự kiện hủy vé
        $(document).on('click', '.rejectBtn', function() {
            const bookingId = $(this).data('id');
            if (confirm('Bạn có chắc chắn muốn hủy vé này?')) {
                rejectBooking(bookingId);
            }
        });
    });
</script>
<script>
    function showContent(id) {
        // Ẩn tất cả các phần tử nội dung
        document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
        // Hiển thị phần tử nội dung được chọn
        document.getElementById(id).classList.add('active');
    }

    // Đảm bảo trang chủ là trang mặc định khi load
    window.onload = function () {
        showContent('dashboard');
    };
</script>

</body>
</html>
